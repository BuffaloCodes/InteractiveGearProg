<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pierce's Chart</title>

  <!-- keep your site assets -->
  <link rel="stylesheet" href="styles/styles.css" />
  <link rel="stylesheet" href="styles/right-clicks.css" />
  <script src="scripts/right-clicks.js"></script>
  <script src="scripts/version.js" defer></script>
  <script data-goatcounter="https://ladlor0interactive0prog.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
  <link rel="icon" href="data:,"><!-- silence favicon 404 -->

  <!-- minimal tab and layout helpers -->
  <style>
    .topbar { position: sticky; top: 0; z-index: 20; background: rgba(0,0,0,.5); backdrop-filter: blur(6px); padding: .5rem .75rem; border-bottom: 1px solid rgba(255,255,255,.08); }
    .tabs { display: inline-flex; gap: .5rem; }
    .tab_btn { appearance: none; border: 1px solid #444; background: transparent; color: inherit; padding: .45rem .8rem; border-radius: .5rem; cursor: pointer; font: inherit; font-weight: 600; }
    .tab_btn:hover { background: rgba(255,255,255,.05); }
    .tab_btn.active { background: rgba(255,255,255,.12); border-color: #555; }

    .wrap { max-width: 1080px; margin: 0 auto; padding: .5rem .75rem 2rem; }
    .panel { display: none; }
    .panel.active { display: block; }
    .subtitle { display: block; margin-bottom: .5rem; }
    .milestone-header { margin-top: 1.25rem; margin-bottom: .5rem; font-size: 1.25rem; border-bottom: 1px solid rgba(255,255,255,.2); padding-bottom: .25rem; }
    .error { background: rgba(220,53,69,.15); border: 1px solid rgba(220,53,69,.35); padding: .75rem; border-radius: .5rem; margin: .75rem 0; }

    /* ==== Hard reset for tab charts only (prevents overlap/absolute/float issues) ==== */
    #chart_gear, #chart_milestones {
      display: flex !important;
      flex-wrap: wrap !important;
      align-items: flex-start !important;
      gap: 12px !important;
      position: relative !important;
      clear: both !important;
    }
    #chart_gear *, #chart_milestones * { float: none !important; }

    /* columns */
    #chart_gear .node-group, #chart_milestones .node-group {
      display: flex !important;
      flex-wrap: wrap !important;
      align-items: flex-start !important;
      gap: 12px !important;
      position: static !important;
    }

    /* item tiles */
    #chart_gear .node, #chart_milestones .node {
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      width: 52px !important;
      height: 52px !important;
      box-sizing: border-box !important;
      position: static !important;
      margin: 0 !important;
      padding: 0 !important;
      border: 0 !important;
      background: transparent !important;
    }

    /* icons */
    #chart_gear .node img, #chart_milestones .node img {
      display: block !important;
      width: 48px !important;
      height: auto !important;
      max-width: none !important;
    }

    /* skill tokens */
    #chart_gear .node .skill, #chart_milestones .node .skill {
      display: inline-flex !important;
      align-items: center !important;
      gap: 6px !important;
    }

    /* headers between groups */
    #chart_gear .milestone-header, #chart_milestones .milestone-header {
      width: 100% !important;
      margin-top: 16px !important;
      margin-bottom: 6px !important;
      font-size: 1.1rem !important;
      border-bottom: 1px solid rgba(255,255,255,.2) !important;
      padding-bottom: 4px !important;
    }

    /* arrows between columns (optional) */
    #chart_gear .arrow, #chart_milestones .arrow {
      align-self: center !important;
      font-weight: 700 !important;
    }

    /* fallback style if your theme doesn’t style .obtained */
    #chart_gear .node.obtained, #chart_milestones .node.obtained {
      outline: 2px solid #48c774;
      outline-offset: 2px;
      border-radius: 6px;
    }
    /* --- Tile look & feel --- */
#chart_gear .node, #chart_milestones .node {
  /* box */
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  width: 50px !important;   /* slightly larger for nicer tap targets */
  height: 50px !important;
  box-sizing: border-box !important;
  border-radius: 8px !important;
  background: #2b2b2b !important;         /* grey box background */
  border: 1px solid rgba(255,255,255,.08) !important;
  box-shadow: 0 1px 2px rgba(0,0,0,.25) !important;
  transition: background .15s ease, transform .05s ease, border-color .15s ease;
}

#chart_gear .node:hover, #chart_milestones .node:hover {
  border-color: rgba(255,255,255,.18) !important;
  transform: translateY(-1px);
}

/* image sizing inside the tile */
#chart_gear .node img, #chart_milestones .node img {
  display: block !important;
  width: 48px !important;
  height: auto !important;
}

/* skill token badge stays readable in the gray tile */
#chart_gear .node .skill, #chart_milestones .node .skill {
  display: inline-flex !important;
  gap: 6px !important;
  font-weight: 700;
}

/* --- Obtained state = green tile (not just outline) --- */
#chart_gear .node.obtained, #chart_milestones .node.obtained {
  background: #2e7d32 !important;            /* green background */
  border-color: rgba(0,0,0,.15) !important;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.12), 0 1px 2px rgba(0,0,0,.3) !important;
}

/* Optional: “unchecked” tiles a hair dimmer for contrast */
#chart_gear .node:not(.obtained), #chart_milestones .node:not(.obtained) {
  filter: saturate(0.92);
}
/* === Ladlor-style palette (adjust here if you want exact hexes) === */
:root {
  --tile-bg: #2b2f36;            /* neutral slate gray */
  --tile-border: rgba(255,255,255,.08);
  --tile-hover-border: rgba(255,255,255,.18);
  --tile-shadow: 0 1px 2px rgba(0,0,0,.25);

  --obtained-bg: #2f8f46;        /* saturated green seen in Ladlor UI */
  --obtained-border: rgba(0,0,0,.15);
  --obtained-inset: inset 0 0 0 1px rgba(255,255,255,.12);

  --context-bg: rgba(20,20,22,0.98);
  --context-title-bg: rgba(255,255,255,.05);
}

/* --- Tile look & feel (applies to both tabs) --- */
#chart_gear .node, #chart_milestones .node {
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  width: 64px !important;
  height: 64px !important;
  box-sizing: border-box !important;
  border-radius: 10px !important;
  background: var(--tile-bg) !important;
  border: 1px solid var(--tile-border) !important;
  box-shadow: var(--tile-shadow) !important;
  transition: background .12s ease, transform .05s ease, border-color .12s ease, box-shadow .12s ease;
}
#chart_gear .node:hover, #chart_milestones .node:hover {
  border-color: var(--tile-hover-border) !important;
  transform: translateY(-1px);
}

/* image sizing */
#chart_gear .node img, #chart_milestones .node img {
  width: 48px !important;
  height: auto !important;
  display: block !important;
}

/* obtained = green fill */
#chart_gear .node.obtained, #chart_milestones .node.obtained {
  background: var(--obtained-bg) !important;
  border-color: var(--obtained-border) !important;
  box-shadow: var(--obtained-inset), 0 1px 2px rgba(0,0,0,.3) !important;
}
#chart_gear .node.obtained:hover, #chart_milestones .node.obtained:hover {
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.18), 0 2px 6px rgba(0,0,0,.35) !important;
}

/* keep the no-overlap layout resets you added earlier */

  </style>
</head>
<body>
  <div class="topbar">
    <div class="tabs">
      <button class="tab_btn" id="btn_milestones">Milestones</button>
      <button class="tab_btn" id="btn_gear">Gear Progression</button>
    </div>
  </div>

  <div class="wrap">
    <!-- Milestones -->
    <section id="panel_milestones" class="panel">
      <h1>Interactive Ironman Progression Chart</h1>
      <span class="subtitle">Curated by the <s>Ironscape</s> fun maxing community — made by BuffaloDad</span>
      <div id="chart_milestones" class="chart"></div>
    </section>

    <!-- Gear -->
    <section id="panel_gear" class="panel">
      <h1>Interactive Ironman Progression Chart</h1>
      <span class="subtitle">Curated by the <s>Ironscape</s> fun maxing community — made by BuffaloDad</span>
      <div id="chart_gear" class="chart"></div>
    </section>

    <h2>Frequently Asked Questions</h2>
    <div class="faq-section">
      <p><strong>Q:</strong> What item is this?</p>
      <p><strong>A:</strong> You can right click the item to see its name and wiki link.</p>
      <p><strong>Q:</strong> How is my progress saved?</p>
      <p><strong>A:</strong> Your progress is saved in local storage in your browser.</p>
    </div>

    <footer>
      <p><span id="version"></span> | <a href="pages/changelog.html">View Changelog</a> | <a href="pages/privacy.html">Privacy Policy</a> | <a href="https://github.com/Madssb/InteractiveGearProg">Source Code</a></p>
      <p>
        All images used in this tool are sourced from the
        <a href="https://oldschool.runescape.wiki/" target="_blank">Old School RuneScape Wiki</a>, and are licensed under the
        <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" target="_blank">Creative Commons Attribution NonCommercial ShareAlike 3.0 License</a>.
        © 2013 to 2024 Jagex Ltd. All rights reserved.
      </p>
    </footer>
  </div>

  <script>
    // data paths
    const PATH_ITEMS = 'data/items.json';
    const PATH_SEQ_GEAR = 'data/sequence_gear.json';
    const PATH_SEQ_MILE = 'data/sequence_milestones.json';

    const SAVE_KEY = 'sharedNodeStatesV1';
    const ACTIVE_TAB_KEY = 'igp_active_tab';

    function setActiveTab(name) {
      const panels = { milestones: document.getElementById('panel_milestones'), gear: document.getElementById('panel_gear') };
      const buttons = { milestones: document.getElementById('btn_milestones'), gear: document.getElementById('btn_gear') };
      Object.values(panels).forEach(p => p.classList.remove('active'));
      Object.values(buttons).forEach(b => b.classList.remove('active'));
      panels[name].classList.add('active');
      buttons[name].classList.add('active');
      try { localStorage.setItem(ACTIVE_TAB_KEY, name); } catch(e) {}
    }
    function getDefaultTab() {
      try {
        const s = localStorage.getItem(ACTIVE_TAB_KEY);
        if (s === 'milestones' || s === 'gear') return s;
      } catch(e) {}
      return 'gear';
    }
    function sanitizeId(name) { return String(name).replace(/[^\w\s-]/g, '').replace(/\s+/g, '-').toLowerCase(); }

    // Prefer item icons if present, only treat as skill when no item entry
    function isSkillToken(s, itemsMap) {
      return (typeof s === 'string') && !itemsMap[s] && /^\d+\s/.test(s);
    }
    function buildSkillNode(token) {
      if (typeof token !== 'string') return null;
      const parts = token.split(' ');
      const lvl = parts[0];
      const skillName = parts.slice(1).join(' ');
      if (!lvl || !skillName) return null;

      const pretty = skillName.charAt(0).toUpperCase() + skillName.slice(1);

      const node = document.createElement('div');
      node.className = 'node';
      node.id = 'lvl-' + sanitizeId(token);
      node.title = `Get ${lvl} ${skillName}`;

      const wrap = document.createElement('div');
      wrap.className = 'skill';

      const img = document.createElement('img');
      img.src = `images/${pretty}_icon.webp`;

      const span = document.createElement('span');
      span.textContent = lvl;

      wrap.appendChild(img); wrap.appendChild(span);
      node.appendChild(wrap);
      return node;
    }
    function buildItemNode(name, itemData) {
      const data = itemData[name];
      if (!data || !data.imgSrc) {
        console.warn('No item data for', name);
        return null; // skip unknowns to avoid layout issues
      }
      const div = document.createElement('div');
      div.className = 'node';
      div.id = sanitizeId(name);
      div.title = name;

      const img = document.createElement('img');
      img.src = data.imgSrc; // path defined in items.json
      img.alt = name;
      div.appendChild(img);

      if (data.wikiLink) div.dataset.wikiLink = data.wikiLink;
      return div;
    }

    function loadSavedStates() { try { return JSON.parse(localStorage.getItem(SAVE_KEY)) || {}; } catch(e) { return {}; } }
    function saveStates(map) { try { localStorage.setItem(SAVE_KEY, JSON.stringify(map)); } catch(e) {} }
    function applyStateAndEvents(container, saved) {
      const nodes = container.querySelectorAll('.node');
      nodes.forEach(node => {
        const id = node.id;
        const st = saved[id] || 0;
        node.dataset.state = st;
        node.classList.remove('state-0','state-1','state-2');
        node.classList.add(`state-${st}`);
        node.classList.toggle('obtained', st === 1); // <- restore classic styling hook
      });

      container.addEventListener('click', ev => {
        const node = ev.target.closest('.node');
        if (!node) return;
        const cur = parseInt(node.dataset.state) || 0;
        const next = cur === 1 ? 0 : 1;
        node.dataset.state = next;
        node.classList.remove('state-0','state-1','state-2');
        node.classList.add(`state-${next}`);
        node.classList.toggle('obtained', next === 1);

        const savedNow = loadSavedStates();
        savedNow[node.id] = next;
        saveStates(savedNow);
      });

      container.addEventListener('dragstart', ev => {
        if (ev.target.tagName === 'IMG') ev.preventDefault();
      });
    }

    function buildHeader(text) {
      const h = document.createElement('h2');
      h.textContent = text;
      h.className = 'milestone-header';
      return h;
    }
    function normalizeSequence(seqJson) {
      // 1) Grouped milestones: { groups: [ { name, items: [...] }, ... ] }
      if (seqJson && Array.isArray(seqJson.groups)) {
        return seqJson.groups.map(g => {
          const col = [{ __header: g.name }];
          if (Array.isArray(g.items)) col.push(...g.items);
          return col;
        });
      }
      // 2) Flat array -> single column
      if (Array.isArray(seqJson)) return [seqJson];
      // 3) Object of arrays -> multiple columns
      if (seqJson && typeof seqJson === 'object') return Object.values(seqJson).map(v => Array.isArray(v) ? v : []);
      return [[]];
    }

    async function renderChartInto(containerId, itemsPath, sequencePath) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = '';

      try {
        const [itemsJson, seqJson] = await Promise.all([
          fetch(itemsPath).then(r => r.json()),
          fetch(sequencePath).then(r => r.json())
        ]);

        const groups = normalizeSequence(seqJson);
        let missingCount = 0;

        // helper: render a single string entry
        function renderOne(entry, targetColDiv) {
          let node = buildItemNode(entry, itemsJson);
          if (!node && isSkillToken(entry, itemsJson)) {
            node = buildSkillNode(entry);
          }
          if (node) {
            targetColDiv.appendChild(node);
          } else {
            missingCount++;
            console.warn('Skipping unknown entry:', entry);
          }
        }

        groups.forEach((col, idx) => {
          const colDiv = document.createElement('div');
          colDiv.className = 'node-group';

          col.forEach(entry => {
            // group header marker
            if (entry && typeof entry === 'object' && entry.__header) {
              colDiv.appendChild(buildHeader(entry.__header));
              return;
            }
            // nested arrays inside a column (flatten and render)
            if (Array.isArray(entry)) {
              entry.forEach(sub => renderOne(sub, colDiv));
              return;
            }
            // normal string item/skill
            renderOne(entry, colDiv);
          });

          container.appendChild(colDiv);

          if (idx !== groups.length - 1) {
            const arrowDiv = document.createElement('div');
            arrowDiv.className = 'arrow';
            arrowDiv.textContent = '→';
            container.appendChild(arrowDiv);
          }
        });

        if (missingCount > 0) {
          const warn = document.createElement('div');
          warn.className = 'error';
          warn.style.cursor = 'pointer';
          warn.title = 'Click to dismiss';
          warn.textContent = `${missingCount} entries were skipped because they did not match any key in data/items.json. Open console for names.`;
          warn.addEventListener('click', () => warn.remove());
          container.prepend(warn);
        }

        applyStateAndEvents(container, loadSavedStates());
      } catch (err) {
        const msg = document.createElement('div');
        msg.className = 'error';
        msg.textContent = 'Failed to load data. Confirm data/items.json and both sequence files exist at those paths.';
        container.appendChild(msg);
        console.error(err);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // render both once
      await renderChartInto('chart_gear', PATH_ITEMS, PATH_SEQ_GEAR);
      await renderChartInto('chart_milestones', PATH_ITEMS, PATH_SEQ_MILE);

      // tabs
      document.getElementById('btn_milestones').addEventListener('click', () => setActiveTab('milestones'));
      document.getElementById('btn_gear').addEventListener('click', () => setActiveTab('gear'));

      // show default
      setActiveTab(getDefaultTab());
    });
  </script>
</body>
</html>
