<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BuffaloDad's Chart</title>

  <!-- keep your site assets -->
  <link rel="stylesheet" href="styles/styles.css" />
  <link rel="stylesheet" href="styles/right-clicks.css" />
  <script src="scripts/right-clicks.js"></script>
  <script src="scripts/version.js" defer></script>
  <script data-goatcounter="https://ladlor0interactive0prog.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
  <link rel="icon" href="data:,"><!-- silence favicon 404 -->

  <style>
    /* Global look */
    html, body { background:#1b1e22; color:#e6e7eb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    .topbar { position: sticky; top: 0; z-index: 20; background: #312a25; backdrop-filter: blur(6px); padding: .5rem .75rem; border-bottom: 1px solid rgba(255,255,255,.08); }
    .tabs { display: inline-flex; gap: .5rem; }
    .tab_btn { appearance:none; border:1px solid #444; background:transparent; color:inherit; padding:.45rem .8rem; border-radius:.5rem; cursor:pointer; font:inherit; font-weight:600; }
    .tab_btn:hover { background: rgba(255,255,255,.05); }
    .tab_btn.active { background: rgba(255,255,255,.12); border-color:#555; }

    .wrap { max-width: 1080px; margin: 0 auto; padding: .5rem .75rem 2rem; }
    .panel { display:none; }
    .panel.active { display:block; }

    .subtitle { display:block; margin-bottom:.5rem; }
    .milestone-header { margin-top:1.25rem; margin-bottom:.5rem; font-size:1.25rem; border-bottom:1px solid rgba(255,255,255,.2); padding-bottom:.25rem; }
    .error { background: rgba(220,53,69,.15); border:1px solid rgba(220,53,69,.35); padding:.75rem; border-radius:.5rem; margin:.75rem 0; }

    /* ==== No-overlap resets for charts ==== */
    #chart_gear, #chart_milestones { display:flex; flex-wrap:wrap; align-items:flex-start; gap:12px; position:relative; clear:both; }
    #chart_gear *, #chart_milestones * { float:none; }

    /* columns (used by Gear) */
    #chart_gear .node-group, #chart_milestones .node-group { display:flex; flex-wrap:wrap; align-items:flex-start; gap:12px; position:static; }
    #chart_gear .arrow, #chart_milestones .arrow { align-self:center; font-weight:700; }

    /* === Ladlor-style palette === */
    :root{
      --tile-bg:#2b2f36;
      --tile-border:rgba(255,255,255,.08);
      --tile-hover-border:rgba(255,255,255,.18);
      --tile-shadow:0 1px 2px rgba(0,0,0,.25);
      --obtained-bg:#2f8f46;
      --obtained-border:rgba(0,0,0,.15);
      --obtained-inset:inset 0 0 0 1px rgba(255,255,255,.12);
    }

    /* item tiles (both tabs) */
    #chart_gear .node, #chart_milestones .node {
      display:inline-flex; align-items:center; justify-content:center;
      width:48px; height:48px; box-sizing:border-box; border-radius:10px;
      background:var(--tile-bg); border:1px solid var(--tile-border); box-shadow:var(--tile-shadow);
      transition: background .12s ease, transform .05s ease, border-color .12s ease, box-shadow .12s ease;
    }
    #chart_gear .node:hover, #chart_milestones .node:hover { border-color:var(--tile-hover-border); transform:translateY(-1px); }
    #chart_gear .node img, #chart_milestones .node img { width:48px; height:auto; display:block; }
    #chart_gear .node.obtained, #chart_milestones .node.obtained { background:var(--obtained-bg); border-color:var(--obtained-border); box-shadow:var(--obtained-inset), 0 1px 2px rgba(0,0,0,.3); }
    #chart_gear .node.obtained:hover, #chart_milestones .node.obtained:hover { box-shadow: inset 0 0 0 1px rgba(255,255,255,.18), 0 2px 6px rgba(0,0,0,.35); }

    /* ===== Milestones: stacked sections (five full-width rectangles) ===== */
    #panel_milestones { background:#22262c; border-radius:12px; padding:12px; }
    #chart_milestones.goal-stack { display:block; gap:0; width:100%; }
    .goal-section { background:#232a2f; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px; margin:12px 0; }
    .goal-grid { display:flex; flex-wrap:wrap; gap:12px; }

    /* Keep milestone icons inside their tiles */
    #chart_milestones .node { width: 48px !important; height: 48px !important; padding: 2px !important; box-sizing: border-box !important; overflow: hidden !important; }
    #chart_milestones .node img { width: 100% !important; height: 100% !important; max-width: 100% !important; max-height: 100% !important; object-fit: contain !important; display: block !important; line-height: 0 !important; }

    /* Touch/long-press polish */
    #chart_milestones, #chart_milestones .goal-grid, #chart_milestones .node { touch-action: manipulation; }
    #chart_gear .node, #chart_milestones .node,
    #chart_gear .node img, #chart_milestones .node img { -webkit-touch-callout: none; user-select: none; }

    /* =========================
       THEME CONTROL (edit me)
       ========================= */
    :root {
      /* Page & text */
      --page-bg:          #28221d;  /* Whole page background */
      --text-color:       #d9d9d9;  /* Default text color */

      /* Top bar (tabs bar) */
      --topbar-bg:        #312a25;  /* Sticky bar behind the two tabs */
      --topbar-border:    rgba(255,255,255,.08);

      /* Tabs (buttons at top) */
      --tab-text:         #e6e7eb;
      --tab-border:       #444444;
      --tab-bg:           transparent;
      --tab-bg-hover:     rgba(255,255,255,.05);
      --tab-bg-active:    rgba(255,255,255,.12);
      --tab-border-active:#555555;

      /* Content wrappers / panels */
      --panel-bg:         #28221d;  /* Milestones panel background */
      --section-bg:       #312a25;  /* Each milestone rectangle */
      --section-border:   #6c665f;

      /* Item tiles (both tabs) */
      --tile-bg:          #2b2f36;
      --tile-border:      rgba(255,255,255,.08);
      --tile-hover-border:#ffffff2e;
      --tile-shadow:      0 1px 2px rgba(0,0,0,.25);

      /* Obtained tiles */
      --obtained-bg:      #2f8f46;
      --obtained-border:  rgba(0,0,0,.15);
      --obtained-inset:   inset 0 0 0 1px rgba(255,255,255,.12);

      /* Alerts / errors */
      --error-bg:         rgba(220,53,69,.15);
      --error-border:     rgba(220,53,69,.35);
    }

    /* Apply tokens */
    html, body { background: var(--page-bg); color: var(--text-color); }
    .topbar { background: var(--topbar-bg); border-bottom: 1px solid var(--topbar-border); }

    .tab_btn {
      color: var(--tab-text);
      border: 1px solid var(--tab-border);
      background: var(--tab-bg);
    }
    .tab_btn:hover { background: var(--tab-bg-hover); }
    .tab_btn.active { background: var(--tab-bg-active); border-color: var(--tab-border-active); }

    #panel_milestones { background: var(--panel-bg); }
    .goal-section { background: var(--section-bg); border: 1px solid var(--section-border); }

    #chart_gear .node, #chart_milestones .node {
      background: var(--tile-bg);
      border: 1px solid var(--tile-border);
      box-shadow: var(--tile-shadow);
    }
    #chart_gear .node:hover, #chart_milestones .node:hover { border-color: var(--tile-hover-border); }
    #chart_gear .node.obtained, #chart_milestones .node.obtained {
      background: var(--obtained-bg);
      border-color: var(--obtained-border);
      box-shadow: var(--obtained-inset), 0 1px 2px rgba(0,0,0,.3);
    }
    .error { background: var(--error-bg); border-color: var(--error-border); }

    /* ===== Milestone section header + progress ===== */
    .goal-section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0 0 10px 0;
    }
    .goal-section-title {
      margin: 0;
      font-size: 1.05rem;
      font-weight: 700;
      letter-spacing: .2px;
      opacity: .95;
      flex: 0 0 auto;
    }
    .goal-progress {
      --pg-height: 10px;
      --pg-bg: rgba(255,255,255,.08);
      --pg-fill: var(--obtained-bg);
      --pg-text: var(--text-color);

      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1 1 auto;
    }
    .goal-progress-track {
      position: relative;
      height: var(--pg-height);
      width: 100%;
      background: var(--pg-bg);
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.08);
    }
    .goal-progress-fill {
      position: absolute;
      inset: 0 auto 0 0;
      width: 0%;
      background: var(--pg-fill);
      border-radius: 999px;
      transition: width .18s ease;
    }
    .goal-progress-label {
      font-size: .9rem;
      opacity: .9;
      white-space: nowrap;
      min-width: 4.5ch;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="tabs">
      <button class="tab_btn" id="btn_milestones">Milestones</button>
      <button class="tab_btn" id="btn_gear">Gear Progression</button>
    </div>
  </div>

  <div class="wrap">
    <!-- Milestones -->
    <section id="panel_milestones" class="panel">
      <h1>Journey of the Iron</h1>
      <span class="subtitle">Curated by the <s>Ironscape</s> fun maxing community — made by BuffaloDad</span>
      <div id="chart_milestones" class="chart"></div>
    </section>

    <!-- Gear -->
    <section id="panel_gear" class="panel">
      <h1>Journey of the Iron</h1>
      <span class="subtitle">Curated by the <s>Ironscape</s> fun maxing community — made by BuffaloDad</span>
      <div id="chart_gear" class="chart"></div>
    </section>

    <h2>Frequently Asked Questions</h2>
    <div class="faq-section">
      <p><strong>Q:</strong> What item is this?</p>
      <p><strong>A:</strong> You can right click the item to see its name and wiki link.</p>
      <p><strong>Q:</strong> How is my progress saved?</p>
      <p><strong>A:</strong> Your progress is saved in local storage in your browser.</p>
    </div>

    <footer>
      <p><span id="version"></span> | <a href="pages/changelog.html">View Changelog</a> | <a href="pages/privacy.html">Privacy Policy</a> | <a href="https://github.com/Madssb/InteractiveGearProg">Source Code</a></p>
      <p>
        All images used in this tool are sourced from the
        <a href="https://oldschool.runescape.wiki/" target="_blank">Old School RuneScape Wiki</a>, and are licensed under the
        <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" target="_blank">Creative Commons Attribution NonCommercial ShareAlike 3.0 License</a>.
        © 2013 to 2024 Jagex Ltd. All rights reserved.
      </p>
    </footer>
  </div>

  <script>
    /* ------------------ paths & state ------------------ */
    const PATH_ITEMS = 'data/items.json';
    const PATH_SEQ_GEAR = 'data/sequence_gear.json';
    const PATH_SEQ_MILE = 'data/sequence_milestones.json';

    const SAVE_KEY = 'sharedNodeStatesV1';
    const ACTIVE_TAB_KEY = 'igp_active_tab';

    function setActiveTab(name) {
      const panels = { milestones: document.getElementById('panel_milestones'), gear: document.getElementById('panel_gear') };
      const buttons = { milestones: document.getElementById('btn_milestones'), gear: document.getElementById('btn_gear') };
      Object.values(panels).forEach(p => p.classList.remove('active'));
      Object.values(buttons).forEach(b => b.classList.remove('active'));
      panels[name].classList.add('active');
      buttons[name].classList.add('active');
      try { localStorage.setItem(ACTIVE_TAB_KEY, name); } catch(e) {}
    }
    function getDefaultTab() {
      try {
        const s = localStorage.getItem(ACTIVE_TAB_KEY);
        if (s === 'milestones' || s === 'gear') return s;
      } catch(e) {}
      return 'gear';
    }
    function sanitizeId(name) { return String(name).replace(/[^\w\s-]/g, '').replace(/\s+/g, '-').toLowerCase(); }

    /* ------------------ tile builders ------------------ */
    function isSkillToken(s, itemsMap) { return (typeof s === 'string') && !itemsMap[s] && /^\d+\s/.test(s); }
    function buildSkillNode(token) {
      if (typeof token !== 'string') return null;
      const parts = token.split(' ');
      const lvl = parts[0]; const skillName = parts.slice(1).join(' ');
      if (!lvl || !skillName) return null;
      const pretty = skillName.charAt(0).toUpperCase() + skillName.slice(1);

      const node = document.createElement('div'); node.className = 'node';
      node.id = 'lvl-' + sanitizeId(token); node.title = `Get ${lvl} ${skillName}`;
      const wrap = document.createElement('div'); wrap.className = 'skill';
      const img = document.createElement('img'); img.src = `images/${pretty}_icon.webp`;
      const span = document.createElement('span'); span.textContent = lvl;
      wrap.appendChild(img); wrap.appendChild(span); node.appendChild(wrap);
      return node;
    }
    function buildItemNode(name, itemData) {
      const data = itemData[name];
      if (!data || !data.imgSrc) { console.warn('No item data for', name); return null; }
      const div = document.createElement('div'); div.className = 'node'; div.id = sanitizeId(name); div.title = name;
      const img = document.createElement('img'); img.src = data.imgSrc; img.alt = name; div.appendChild(img);
      if (data.wikiLink) div.dataset.wikiLink = data.wikiLink;
      return div;
    }

    /* ------------------ state handling ------------------ */
    function loadSavedStates() { try { return JSON.parse(localStorage.getItem(SAVE_KEY)) || {}; } catch(e) { return {}; } }
    function saveStates(map) { try { localStorage.setItem(SAVE_KEY, JSON.stringify(map)); } catch(e) {} }
    function applyStateAndEvents(container, saved) {
      const nodes = container.querySelectorAll('.node');
      nodes.forEach(node => {
        const id = node.id; const st = saved[id] || 0;
        node.dataset.state = st;
        node.classList.remove('state-0','state-1','state-2'); node.classList.add(`state-${st}`);
        node.classList.toggle('obtained', st === 1);
      });

      container.addEventListener('click', ev => {
        // Skip toggle if context menu is open or just opened
        if (window.__igp_menu_open && window.__igp_menu_open()) return;
        if (window.__igp_suppress_click && window.__igp_suppress_click()) return;

        const node = ev.target.closest('.node');
        if (!node) return;

        const cur = parseInt(node.dataset.state) || 0;
        const next = cur === 1 ? 0 : 1;

        node.dataset.state = next;
        node.classList.remove('state-0','state-1','state-2'); node.classList.add(`state-${next}`);
        node.classList.toggle('obtained', next === 1);

        const savedNow = loadSavedStates();
        savedNow[node.id] = next;
        saveStates(savedNow);

        // update progress if this click happened inside a milestones section
        const section = node.closest('.goal-section');
        if (section) updateSectionProgress(section);
      });

      container.addEventListener('dragstart', ev => {
        if (ev.target.tagName === 'IMG') ev.preventDefault();
      });
    }

    /* ------------------ Gear (existing layout) ------------------ */
    function normalizeSequence(seqJson) {
      if (seqJson && Array.isArray(seqJson.groups)) {
        return seqJson.groups.map(g => {
          const col = [{ __header: g.name }]; if (Array.isArray(g.items)) col.push(...g.items); return col;
        });
      }
      if (Array.isArray(seqJson)) return [seqJson];
      if (seqJson && typeof seqJson === 'object') return Object.values(seqJson).map(v => Array.isArray(v) ? v : []);
      return [[]];
    }

    async function renderChartInto(containerId, itemsPath, sequencePath) {
      const container = document.getElementById(containerId); if (!container) return;
      container.innerHTML = '';
      try {
        const [itemsJson, seqJson] = await Promise.all([ fetch(itemsPath).then(r => r.json()), fetch(sequencePath).then(r => r.json()) ]);
        const groups = normalizeSequence(seqJson);
        let missingCount = 0;

        function renderOne(entry, targetColDiv) {
          let node = buildItemNode(entry, itemsJson);
          if (!node && isSkillToken(entry, itemsJson)) node = buildSkillNode(entry);
          if (node) targetColDiv.appendChild(node); else { missingCount++; console.warn('Skipping unknown entry:', entry); }
        }

        groups.forEach((col, idx) => {
          const colDiv = document.createElement('div'); colDiv.className = 'node-group';
          col.forEach(entry => {
            if (entry && typeof entry === 'object' && entry.__header) { colDiv.appendChild(buildHeader(entry.__header)); return; }
            if (Array.isArray(entry)) { entry.forEach(sub => renderOne(sub, colDiv)); return; }
            renderOne(entry, colDiv);
          });
          container.appendChild(colDiv);
          if (idx !== groups.length - 1) { const arrowDiv = document.createElement('div'); arrowDiv.className = 'arrow'; arrowDiv.textContent = '→'; container.appendChild(arrowDiv); }
        });

        if (missingCount > 0) {
          const warn = document.createElement('div'); warn.className = 'error'; warn.style.cursor='pointer'; warn.title='Click to dismiss';
          warn.textContent = `${missingCount} entries were skipped because they did not match any key in data/items.json. Open console for names.`; warn.addEventListener('click', () => warn.remove()); container.prepend(warn);
        }
        applyStateAndEvents(container, loadSavedStates());
      } catch (err) {
        const msg = document.createElement('div'); msg.className='error'; msg.textContent='Failed to load data. Confirm data/items.json and both sequence files exist at those paths.'; container.appendChild(msg);
        console.error(err);
      }
    }
    function buildHeader(text) { const h=document.createElement('h2'); h.textContent=text; h.className='milestone-header'; return h; }

    /* ------------------ Milestones: progress helpers ------------------ */
    function computeSectionProgress(sectionEl) {
      const nodes = sectionEl.querySelectorAll('.goal-grid .node');
      const total = nodes.length;
      if (total === 0) return { obtained: 0, total: 0, pct: 0 };
      let obtained = 0;
      nodes.forEach(n => {
        const st = parseInt(n.dataset.state) || 0;
        if (st === 1 || n.classList.contains('obtained')) obtained++;
      });
      const pct = Math.round((obtained / total) * 100);
      return { obtained, total, pct };
    }
    function updateSectionProgress(sectionEl) {
      const { obtained, total, pct } = computeSectionProgress(sectionEl);
      const fill = sectionEl.querySelector('.goal-progress-fill');
      const label = sectionEl.querySelector('.goal-progress-label');
      if (fill) fill.style.width = `${pct}%`;
      if (label) label.textContent = `${pct}%`;
      const track = sectionEl.querySelector('.goal-progress-track');
      if (track) track.title = `${obtained} / ${total} obtained`;
    }

    /* ------------------ Milestones: stacked sections w/ progress ------------------ */
    function extractMilestoneGroups(seqJson) {
      // Accept either {groups:[{name,items}...]} or {"Easy Goals":[...], "Medium Goals":[...], ...}
      if (seqJson && Array.isArray(seqJson.groups)) return seqJson.groups;

      if (seqJson && typeof seqJson === 'object' && !Array.isArray(seqJson)) {
        const wanted = ['Easy Goals','Medium Goals','Hard Goals','Elite Goals','Master Goals'];
        const keys = Object.keys(seqJson);
        const findKey = (label) => {
          const needle = label.toLowerCase();
          const alt = label.replace(/\s*goals\s*/i,'').toLowerCase();
          return keys.find(k => {
            const kk = String(k).toLowerCase().trim();
            return kk === needle || kk === alt;
          });
        };
        return wanted.map(label => {
          const k = findKey(label);
          let items = [];
          if (k) {
            const v = seqJson[k];
            if (Array.isArray(v)) items = v;
            else if (v && Array.isArray(v.items)) items = v.items;
          }
          return { name: label, items };
        });
      }

      if (Array.isArray(seqJson)) return [{ name: 'Goals', items: seqJson }];
      return [];
    }

    async function renderMilestonesInto(containerId, itemsPath, sequencePath) {
      const container = document.getElementById(containerId); if (!container) return;
      container.innerHTML = ''; container.classList.add('goal-stack');

      try {
        const [itemsJson, seqJson] = await Promise.all([ fetch(itemsPath).then(r => r.json()), fetch(sequencePath).then(r => r.json()) ]);
        const groups = extractMilestoneGroups(seqJson) || [];
        let missingCount = 0;

        const renderOne = (entry, target) => {
          let node = buildItemNode(entry, itemsJson);
          if (!node && isSkillToken(entry, itemsJson)) node = buildSkillNode(entry);
          if (node) target.appendChild(node); else { missingCount++; console.warn('Skipping unknown entry:', entry); }
        };

        if (!groups.length) {
          const msg = document.createElement('div'); msg.className='error';
          msg.textContent = 'No milestone groups found. Ensure sequence_milestones.json is either {"groups":[{name,items}...]} or an object with "Easy/Medium/Hard/Elite/Master Goals" keys.';
          container.appendChild(msg);
        }

        groups.forEach(g => {
          const section = document.createElement('div'); section.className='goal-section';

          /* header with title + progress bar */
          const header = document.createElement('div'); header.className = 'goal-section-header';

          const title = document.createElement('h3');
          title.className = 'goal-section-title';
          title.textContent = g.name || 'Goals';

          const progress = document.createElement('div'); progress.className = 'goal-progress';
          const track = document.createElement('div'); track.className = 'goal-progress-track';
          const fill = document.createElement('div'); fill.className = 'goal-progress-fill'; track.appendChild(fill);
          const label = document.createElement('div'); label.className = 'goal-progress-label'; label.textContent = '0%';

          progress.appendChild(track);
          progress.appendChild(label);

          header.appendChild(title);
          header.appendChild(progress);
          section.appendChild(header);

          /* items grid */
          const grid = document.createElement('div'); grid.className='goal-grid';

          const items = Array.isArray(g.items) ? g.items : [];
          items.forEach(entry => { if (Array.isArray(entry)) entry.forEach(sub => renderOne(sub, grid)); else renderOne(entry, grid); });

          section.appendChild(grid);
          container.appendChild(section);
        });

        if (missingCount > 0) {
          const warn = document.createElement('div'); warn.className='error'; warn.style.cursor='pointer'; warn.title='Click to dismiss';
          warn.textContent = `${missingCount} milestone entries were skipped (no match in data/items.json). Check console for names.`; warn.addEventListener('click', () => warn.remove()); container.prepend(warn);
        }

        applyStateAndEvents(container, loadSavedStates());

        // initialize progress bars now that states are applied
        container.querySelectorAll('.goal-section').forEach(updateSectionProgress);

      } catch (err) {
        const msg = document.createElement('div'); msg.className='error'; msg.textContent='Failed to load milestones. Confirm data/items.json and data/sequence_milestones.json.'; container.appendChild(msg);
        console.error(err);
      }
    }

    /* ------------------ boot ------------------ */
    document.addEventListener('DOMContentLoaded', async () => {
      // render both once
      await renderChartInto('chart_gear', PATH_ITEMS, PATH_SEQ_GEAR);              // Gear unchanged
      await renderMilestonesInto('chart_milestones', PATH_ITEMS, PATH_SEQ_MILE);   // Milestones = stacked sections w/ progress

      // tabs
      document.getElementById('btn_milestones').addEventListener('click', () => setActiveTab('milestones'));
      document.getElementById('btn_gear').addEventListener('click', () => setActiveTab('gear'));

      // show default
      setActiveTab(getDefaultTab());
    });
  </script>
</body>
</html>
